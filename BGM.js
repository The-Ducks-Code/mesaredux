document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("BGM");if(!t)return;const e=t.getAttribute("data-local-src")||"/assets/music/whosthere.mp3",a=t.getAttribute("data-track-list"),r=(e={},a="")=>{const r=e.title||e.name||"",s=e.artist||e.by||e.author||"",c=e.album||"",l=e.display||e.label||"",o=a||e.src||"",n=o?decodeURIComponent(o.split("/").pop()||""):"",i=r||n,d=s,u=l||[d,i].filter(Boolean).join(" â€” ")||n||"";i?t.dataset.trackTitle=i:delete t.dataset.trackTitle,d?t.dataset.trackArtist=d:delete t.dataset.trackArtist,c?t.dataset.trackAlbum=c:delete t.dataset.trackAlbum,u?t.dataset.trackDisplay=u:delete t.dataset.trackDisplay,o?t.dataset.trackSource=o:delete t.dataset.trackSource,t.dispatchEvent(new CustomEvent("trackmetadatachange",{detail:{title:t.dataset.trackTitle||"",artist:t.dataset.trackArtist||"",album:t.dataset.trackAlbum||"",display:t.dataset.trackDisplay||"",src:t.dataset.trackSource||""}}))},s=t=>{if(!t)return"";return`${"https://mesareudx.mesagrey.ca/".replace(/\/+$/,"")}${t.startsWith("/")?t:`/${t}`}`},c=()=>{t.volume=.5,t.loop=!0;const e=t.play();return e&&"function"==typeof e.catch?e.catch((t=>{console.warn("Audio playback was prevented:",t)})):Promise.resolve()},l=(a,l={},o={})=>((a,r={})=>new Promise((c=>{const l=r.remoteFallback;return a?/^https?:\/\//i.test(a)?(t.src=a,void c(t.src)):void fetch(a,{method:"HEAD"}).then((e=>{e.ok?t.src=a:t.src=l||s(a)})).catch((()=>{t.src=l||s(a)})).finally((()=>c(t.src))):(t.src=l||s(e),void c(t.src))})))(a,o).then((t=>(r({...l,src:t||a||""},t||a||""),c()))),o=()=>l(e);a?fetch(a).then((t=>{if(!t.ok)throw new Error(`Failed to load playlist: ${a}`);return t.json()})).then((e=>{const a=(t=>{if(!t)return null;const e=Array.isArray(t)?t:Array.isArray(t.tracks)?t.tracks:[];return e.length?e[Math.floor(Math.random()*e.length)]:null})(e);if(!a)return o();if("string"==typeof a)return l(a);if(a&&"object"==typeof a){const e={title:a.title||a.name,artist:a.artist||a.by||a.author,album:a.album,display:a.display||a.label},s=a.sources||{},o=a.local||a.src||a.path||a.file||s.local||s.src||s.path,n=a.remote||a.url||a.href||s.remote||s.url;if(o)return l(o,e,{remoteFallback:n});if(n)return t.src=n,r({...e,src:n},n),c()}return o()})).catch((t=>(console.error("Error loading audio playlist:",t),o()))):o()}));
