{% assign current_game_group = page.parent_dir | default: '' %}
{% if current_game_group == '' %}
  {% assign current_path_source = page.relative_path | default: page.path %}
  {% assign current_path = current_path_source | remove_first: '_games/' %}
  {% assign current_segments = current_path | split: '/' %}
  {% assign current_segment_count = current_segments | size %}
  {% assign current_limit = current_segment_count | minus: 1 %}
  {% if current_limit > 0 %}
    {% assign current_game_group = current_segments | slice: 0, current_limit | join: '/' %}
  {% else %}
    {% assign current_game_group = '' %}
  {% endif %}
{% endif %}
{% assign current_prefix = current_game_group | append: '/' %}
{% assign expected_child_limit = current_limit | plus: 1 %}
{% if current_game_group == '' %}
  {% assign current_branch_prefix = '' %}
{% else %}
  {% assign current_branch_prefix = current_game_group | append: '/' %}
{% endif %}
{% assign current_branch_prefix_length = current_branch_prefix | size %}
{% assign back_url = '/games' %}
{% if page.index and current_game_group contains '/' %}
  {% assign group_segments = current_game_group | split: '/' %}
  {% assign parent_count = group_segments | size | minus: 1 %}
  {% assign parent_segments = group_segments | slice: 0, parent_count %}
  {% assign parent_group = parent_segments | join: '/' %}
  {% assign back_url = '/games/' | append: parent_group | append: '/index' %}
{% endif %}
<div class="games-gallery">
  {% assign nested_games = site.games | sort: 'title' %}
  {% for game in nested_games %}
    {% assign parent_dir = game.parent_dir | default: '' %}
    {% if parent_dir == '' %}
      {% assign game_path_source = game.relative_path | default: game.path %}
      {% assign game_path = game_path_source | remove_first: '_games/' %}
      {% assign game_segments = game_path | split: '/' %}
      {% assign game_segment_count = game_segments | size %}
      {% if game_segment_count > 1 %}
        {% assign game_limit = game_segment_count | minus: 1 %}
        {% assign parent_dir = game_segments | slice: 0, game_limit | join: '/' %}
      {% else %}
        {% assign game_limit = 0 %}
        {% assign parent_dir = '' %}
      {% endif %}
    {% else %}
      {% assign game_limit = parent_dir | split: '/' | size %}
    {% endif %}

    {% assign should_render = false %}
    {% if game.url != page.url %}
      {% if parent_dir == current_game_group and game_limit == current_limit %}
        {% assign should_render = true %}
      {% elsif game_limit == expected_child_limit %}
        {% assign parent_prefix = parent_dir | slice: 0, current_branch_prefix_length %}
        {% if parent_prefix == current_branch_prefix %}
          {% assign parent_length = parent_dir | size %}
          {% assign remainder = parent_dir | slice: current_branch_prefix_length, parent_length %}
          {% unless remainder contains '/' %}
            {% assign should_render = true %}
          {% endunless %}
        {% endif %}
      {% endif %}
    {% endif %}

    {% if should_render %}
      <a class="game-card" href="{{ game.url }}">
        <div class="thumb-wrap">
          <img src="{{ game.url | append: 'thumb.png' }}"
               alt="{{ game.title }} thumbnail"
               loading="lazy"
               onerror="this.onerror=null;this.src='/assets/images/placeholder.png';" />
        </div>
        <div class="game-meta">
          <div class="game-title">{{ game.title }}</div>
        </div>
      </a>
    {% endif %}
  {% endfor %}
</div>
<div style="display: flex; justify-content: center; align-items: center; padding-top:10px;">
<a href="{{ back_url | relative_url }}" class="back">back</a>
</div>